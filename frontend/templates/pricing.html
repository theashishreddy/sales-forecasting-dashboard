{% extends "base.html" %}
{% block content %}

<h2>ðŸ’° Price Optimization</h2>

<!-- PRODUCT SELECT -->
<select id="productSelect" style="margin-bottom:15px; padding:6px;">
  <option value="">All Products (Overall)</option>
</select>

<!-- KPI CARDS -->
<div style="display:flex; gap:20px; margin-bottom:20px;">
  <div class="card">
    <h4>Optimal Price</h4>
    <h2 id="optPrice">â€“</h2>
  </div>
  <div class="card">
    <h4>Expected Revenue</h4>
    <h2 id="optRevenue">â€“</h2>
  </div>
  <div class="card">
    <h4>Demand Type</h4>
    <p id="elasticity">â€“</p>
  </div>
</div>

<!-- CHART -->
<div class="card">
  <canvas id="priceChart" height="120"></canvas>
</div>

<!-- AI INSIGHT -->
<div class="card" style="margin-top:20px;">
  <h3>ðŸ¤– Pricing Insight</h3>
  <p id="aiText">Select a product to view insights.</p>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Required for the red dot + label at optimal price -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2"></script>

<script>
let chart = null;

function loadPricing(product) {
  const url = `/price-optimize${product ? `?product=${encodeURIComponent(product)}` : ""}`;

  fetch(url)
    .then(r => {
      if (!r.ok) throw new Error(`Server error: ${r.status}`);
      return r.json();
    })
    .then(d => {
      // Handle backend error message
      if (d.error) {
        document.getElementById("optPrice").innerText = "â€”";
        document.getElementById("optRevenue").innerText = "â€”";
        document.getElementById("elasticity").innerText = "Not Available";
        document.getElementById("aiText").innerText = "âš ï¸ " + d.error;
        if (chart) chart.destroy();
        chart = null;
        return;
      }

      // Update KPI cards
      document.getElementById("optPrice").innerText = 
          "â‚¹" + Number(d.optimal_price).toLocaleString("en-IN");
      document.getElementById("optRevenue").innerText = 
          "â‚¹" + Number(d.expected_revenue).toLocaleString("en-IN");
      document.getElementById("elasticity").innerText = d.elasticity_type;

      // AI Insight text
      document.getElementById("aiText").innerText = 
          `${d.elasticity_type}. Recommended price: â‚¹${Number(d.optimal_price).toLocaleString("en-IN")} â†’ ` +
          `Projected maximum revenue: â‚¹${Number(d.expected_revenue).toLocaleString("en-IN")}`;

      // Prepare chart data
      const prices = d.curve.map(item => "â‚¹" + Number(item.price).toLocaleString("en-IN"));
      const revenues = d.curve.map(item => item.revenue);

      // Destroy previous chart if exists
      if (chart) chart.destroy();

      // Create new chart
      chart = new Chart(document.getElementById("priceChart"), {
        type: "line",
        data: {
          labels: prices,
          datasets: [{
            label: "Projected Revenue (â‚¹)",
            data: revenues,
            borderColor: "#22c55e",
            backgroundColor: "rgba(34, 197, 94, 0.1)",
            fill: true,
            tension: 0.4,
            pointRadius: 4,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: "top"
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return "Revenue: â‚¹" + context.parsed.y.toLocaleString("en-IN");
                }
              }
            },
            annotation: {
              annotations: {
                optimalPoint: {
                  type: "point",
                  xValue: "â‚¹" + Number(d.optimal_price).toLocaleString("en-IN"),
                  yValue: d.expected_revenue,
                  backgroundColor: "#ef4444",
                  radius: 10,
                  borderWidth: 4,
                  borderColor: "#ffffff"
                },
                optimalLabel: {
                  type: "label",
                  xValue: "â‚¹" + Number(d.optimal_price).toLocaleString("en-IN"),
                  yValue: d.expected_revenue,
                  content: ["Optimal Price", "â‚¹" + Number(d.optimal_price).toLocaleString("en-IN")],
                  backgroundColor: "rgba(31, 41, 55, 0.9)",
                  color: "#ffffff",
                  font: { weight: "bold", size: 13 },
                  padding: 10,
                  borderRadius: 8,
                  yAdjust: -40
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: value => "â‚¹" + Number(value).toLocaleString("en-IN")
              }
            },
            x: {
              ticks: {
                maxRotation: 45,
                minRotation: 45
              }
            }
          }
        }
      });
    })
    .catch(err => {
      console.error("Pricing load failed:", err);
      document.getElementById("aiText").innerText = 
          "ðŸš¨ Failed to load pricing data. Please ensure sales.csv is uploaded with multiple price points.";
      if (chart) chart.destroy();
      chart = null;
    });
}

// Load product list and initial overall pricing
fetch("/products")
  .then(r => r.json())
  .then(products => {
    const select = document.getElementById("productSelect");
    // Clear any existing options except the first "All Products"
    select.innerHTML = '<option value="">All Products (Overall)</option>';

    products.forEach(p => {
      const opt = document.createElement("option");
      opt.value = p.product_name;
      opt.textContent = p.product_name;
      select.appendChild(opt);
    });

    // Load overall pricing on page load
    loadPricing("");
  })
  .catch(err => {
    console.error("Failed to load products:", err);
    document.getElementById("aiText").innerText = "ðŸš¨ Could not load product list.";
  });

// Product selection change
document.getElementById("productSelect").addEventListener("change", e => {
  loadPricing(e.target.value);
});
</script>
{% endblock %}